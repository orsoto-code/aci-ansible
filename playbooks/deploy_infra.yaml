---
- name: "Despliegue Integral de Infraestructura Cisco ACI"
  hosts: apic01
  gather_facts: no
  vars_files:
    - "/ansible/var/network_model.yaml"

  tasks:
    - name: "Configurar Tenants"
      cisco.aci.aci_tenant:
        hostname: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        validate_certs: no
        tenant: "{{ item.name }}"
        description: "{{ item.description | default(omit) }}"
        state: present
      loop: "{{ aci_infrastructure.tenants }}"
      delegate_to: localhost

    - name: "Configurar VRFs"
      cisco.aci.aci_vrf:
        hostname: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        validate_certs: no
        tenant: "{{ item.0.name }}"
        vrf: "{{ item.1.name }}"
        state: present
      loop: "{{ aci_infrastructure.tenants | subelements('vrfs') }}"

    - name: "Configurar Bridge Domains (L2/L3 Policy)"
      cisco.aci.aci_bd:
        hostname: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        validate_certs: no
        tenant: "{{ item.0.name }}"
        bd: "{{ item.1.name }}"
        vrf: "{{ item.1.vrf }}"
        l2_unknown_unicast: "{{ item.1.l2_unknown_unicast | default('proxy') }}"
        unicast_routing: "{{ item.1.unicast_routing | default('yes') }}"
        arp_flood: "{{ item.1.arp_flood | default('no') }}"
        state: present
      loop: "{{ aci_infrastructure.tenants | subelements('bds') }}"

    - name: "Configurar Subnets en los BDs"
      cisco.aci.aci_bd_subnet:
        hostname: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        validate_certs: no
        tenant: "{{ item.0.name }}"
        bd: "{{ item.1.name }}"
        gateway: "{{ item.2.gateway }}"
        scope: "{{ item.2.scope | default('private') }}"
        state: present
      loop: >
        {% set subnet_list = [] %}
        {% for tenant in aci_infrastructure.tenants %}
          {% for bd in tenant.bds %}
            {% for subnet in bd.subnets %}
              {% set _ = subnet_list.append([tenant, bd, subnet]) %}
            {% endfor %}
          {% endfor %}
        {% endfor %}
        {{ subnet_list }}

    - name: "Configurar Application Profiles"
      cisco.aci.aci_ap:
        hostname: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        validate_certs: no
        tenant: "{{ item.0.name }}"
        ap: "{{ item.1.name }}"
        state: present
      loop: "{{ aci_infrastructure.tenants | subelements('app_profiles') }}"

    - name: "Configurar EPGs"
      cisco.aci.aci_epg:
        hostname: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        validate_certs: no
        tenant: "{{ item.0.tenant }}"
        ap: "{{ item.0.ap }}"
        epg: "{{ item.1.name }}"
        bd: "{{ item.1.bd }}"
        state: present
      loop: >
        {% set epg_list = [] %}
        {% for tenant in aci_infrastructure.tenants %}
          {% for ap in tenant.app_profiles %}
            {% for epg in ap.epgs %}
              {% set _ = epg_list.append([{'tenant': tenant.name, 'ap': ap.name}, epg]) %}
            {% endfor %}
          {% endfor %}
        {% endfor %}
        {{ epg_list }}

    - name: "Asociar EPGs a Dominios"
      cisco.aci.aci_epg_to_domain:
        hostname: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        validate_certs: no
        tenant: "{{ item.tenant }}"
        ap: "{{ item.ap }}"
        epg: "{{ item.epg }}"
        domain: "{{ item.domain_name }}"
        domain_type: "{{ item.domain_type }}"
        state: present
      loop: >
        {% set dom_list = [] %}
        {% for t in aci_infrastructure.tenants %}
          {% for ap in t.app_profiles %}
            {% for epg in ap.epgs %}
              {% for dom in epg.domains %}
                {% set _ = dom_list.append({'tenant': t.name, 'ap': ap.name, 'epg': epg.name, 'domain_name': dom.name, 'domain_type': dom.type}) %}
              {% endfor %}
            {% endfor %}
          {% endfor %}
        {% endfor %}
        {{ dom_list }}

    - name: "Configurar Static Paths (Port, PC, vPC)"
      cisco.aci.aci_static_binding_to_epg:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        validate_certs: no

        tenant: "{{ item.tenant }}"
        ap: "{{ item.ap }}"
        epg: "{{ item.epg }}"
        pod_id: "{{ item.pod | default(1) }}"

        # - vpc: lista de leafs
        # - switch_port/port_channel: un leaf (string/int) suele bastar
        leafs: "{{ item.leafs }}"

        interface_type: "{{ item.interface_type }}"
        interface: "{{ item.interface }}"
        interface_mode: "{{ item.mode | default('regular') }}"
        encap_id: "{{ item.vlan }}"
        deploy_immediacy: "immediate"
        state: present
      loop: >
        {% set path_list = [] %}
        {% for t in aci_infrastructure.tenants %}
          {% for ap in t.app_profiles %}
            {% for epg in ap.epgs %}
              {% if epg.static_paths is defined %}
                {% for sp in epg.static_paths %}

                  {# 1) Determinar interface_type #}
                  {% set itype = 'vpc' if sp.vpc is defined else ('port_channel' if sp.port_channel is defined else 'switch_port') %}

                  {# 2) Determinar interface #}
                  {% if itype == 'switch_port' %}
                    {# Normaliza "eth1/10" -> "1/10" si viene as√≠ #}
                    {% set iface = (sp.port | string) | regex_replace('^eth', '') %}
                  {% elif itype == 'port_channel' %}
                    {% set iface = sp.port_channel %}
                  {% else %}
                    {% set iface = sp.vpc %}
                  {% endif %}

                  {# 3) Determinar leafs: si vPC debe ser lista; si no, un leaf #}
                  {% if itype == 'vpc' %}
                    {% set leafs_val = sp.leafs if sp.leafs is defined else sp.leaf %}
                  {% else %}
                    {% set leafs_val = sp.leafs if sp.leafs is defined else sp.leaf %}
                  {% endif %}

                  {% set _ = path_list.append({
                    'tenant': t.name,
                    'ap': ap.name,
                    'epg': epg.name,
                    'pod': sp.pod | default(1),
                    'leafs': leafs_val,
                    'vlan': sp.vlan,
                    'mode': sp.mode | default('regular'),
                    'interface_type': itype,
                    'interface': iface
                  }) %}
                {% endfor %}
              {% endif %}
            {% endfor %}
          {% endfor %}
        {% endfor %}
        {{ path_list }}
      delegate_to: localhost
